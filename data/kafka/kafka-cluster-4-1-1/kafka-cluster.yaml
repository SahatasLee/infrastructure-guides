apiVersion: kafka.strimzi.io/v1
kind: Kafka
metadata:
  name: kafka-cluster-kraft-poc-4-1-1
  annotations:
    strimzi.io/node-pools: enabled
    strimzi.io/kraft: enabled
spec:
  kafka:
    # Kafka version (recommended)
    version: 4.1.1
    # Metadata version (recommended)
    metadataVersion: 4.1-IV1
    # Listener configuration (required)
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
        authentication:
          type: scram-sha-512
      - name: external
        port: 9094
        type: loadbalancer
        tls: false
        authentication:
          type: scram-sha-512
        configuration:
          bootstrap:
            loadBalancerIP: 10.10.1.6
          brokers:
            - broker: 0
              loadBalancerIP: 10.10.1.7
            - broker: 1
              loadBalancerIP: 10.10.1.8
            - broker: 2
              loadBalancerIP: 10.10.1.9
    # Kafka configuration (recommended)
    config:
      auto.create.topics.enable: "false"
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      default.replication.factor: 3
      min.insync.replicas: 2
      # inter.broker.protocol.version: "3.9"
      # log.message.format.version: "3.9"
    # Logging configuration (optional)
    logging: # (13)
      type: inline
      loggers:
        # Kafka 4.0+ uses Log4j2
        # rootLogger.level: INFO
        rootLogger.level: "INFO, WARN, ERROR"
    # Readiness probe (optional)
    readinessProbe: # (14)
      initialDelaySeconds: 15
      timeoutSeconds: 5
    # Liveness probe (optional)
    livenessProbe:
      initialDelaySeconds: 15
      timeoutSeconds: 5
    # JVM options (optional)
    #jvmOptions: # (15)
    #  -Xms: 8192m # 8GB
    #  -Xmx: 8192m # 8GB
    # Custom image (optional)
    # image: my-org/my-image:latest # (16)
    # Authorization (optional)
    authorization: # (17)
      type: simple
    # Rack awareness (optional)
    # rack: # (18)
    #   topologyKey: topology.kubernetes.io/zone
    # Metrics configuration (optional)
    metricsConfig: # (19)
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef: # (20)
          name: kafka-metrics
          key: kafka-metrics-config.yml
    template:
      kafkaContainer:
        env:
          - name: TZ
            value: "Asia/Bangkok"
      pod:
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - podAffinityTerm:
                  labelSelector:
                    matchLabels:
                      strimzi.io/cluster: kafka-cluster-kraft-poc-4-1-1
                      strimzi.io/name: kafka-cluster-kraft-poc-4-1-1
                  topologyKey: kubernetes.io/hostname
                weight: 100
  # Entity Operator (recommended)
  entityOperator:
    topicOperator:
      # watchedNamespace: my-topic-namespace
      # reconciliationIntervalMs: 60000
      # Resources requests and limits (recommended)
      resources:
        requests:
          memory: 512Mi
          cpu: "1"
        limits:
          memory: 512Mi
          cpu: "1"
      logging:
        type: inline
        loggers:
          rootLogger.level: "INFO, WARN, ERROR"
    userOperator:
      # watchedNamespace: my-topic-namespace
      # reconciliationIntervalMs: 60000
      # Resources requests and limits (recommended)
      resources:
        requests:
          memory: 512Mi
          cpu: "1"
        limits:
          memory: 512Mi
          cpu: "1"
      # Logging configuration (optional)
      logging:
        type: inline
        loggers:
          rootLogger.level: "INFO, WARN, ERROR"
  kafkaExporter:
    topicRegex: ".*"
    groupRegex: ".*"
    # Ensure it restarts automatically if it hangs
    livenessProbe:
      initialDelaySeconds: 15
      # initialDelaySeconds: 120
      periodSeconds: 10
      timeoutSeconds: 15
    # Ensure traffic isn't sent until it's ready
    readinessProbe:
      initialDelaySeconds: 15
      # initialDelaySeconds: 120
      periodSeconds: 10
      timeoutSeconds: 300
    # Prevent crashing on large clusters
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    logging:
      type: inline
      loggers:
        rootLogger.level: "INFO, DEBUG, ERROR"
  cruiseControl:
    metricsConfig:
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef:
          name: cruise-control-metrics
          key: metrics-config.yml
    # Prevent crashing on large clusters
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    logging:
      type: inline
      loggers:
        rootLogger.level: "INFO, DEBUG, ERROR"
